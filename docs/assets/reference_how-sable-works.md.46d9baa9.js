import{_ as s,o as n,c as a,Q as o}from"./chunks/framework.b8722102.js";const F=JSON.parse('{"title":"How Sable Works","description":"","frontmatter":{},"headers":[],"relativePath":"reference/how-sable-works.md","filePath":"reference/how-sable-works.md"}'),l={name:"reference/how-sable-works.md"},p=o(`<h1 id="how-sable-works" tabindex="-1">How Sable Works <a class="header-anchor" href="#how-sable-works" aria-label="Permalink to &quot;How Sable Works&quot;">​</a></h1><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>To set the stage for talking about how <strong>Sable</strong> works, let&#39;s first talk about how things works without <strong>Sable</strong>. Without <strong>Sable</strong>, you&#39;d just use the <a href="https://martendb.io/configuration/cli.html#command-line-tooling" target="_blank" rel="noreferrer">Marten Command Line Tooling</a> support to run commands like <code>marten-patch</code> and <code>marten-apply</code> on your project. <strong>Sable</strong> does not add any additional functionality to that toolset. In fact, it is built on top of it, and will literally just run those same commands that you&#39;d run manually.</p><p>When manually using the command line tooling support, you need to connect to an actual database, which introduces the problems outlined in <a href="./../introduction/why-sable.html">Why Sable</a>. <strong>Sable</strong> solves those problems by using a temporary shadow database instead of an actual one. For instance, when running the <strong>Sable</strong> command to create a new migration, <strong>Sable</strong> will:</p><ul><li>Dynamically create a Postgres docker container to be used as the shadow database.</li><li>Create a script from the existing migrations.</li><li>Apply the script to build the shadow database.</li><li>Run the <code>marten-patch</code> command on your project. That command is executed in a context where an environment variable is set by Sable. That environment variable is then used to override the connection string for Marten in the project so that it points to the Docker container instead of an actual database. The script generated by Marten is then saved in a sable <code>migrations</code> directory. If no changes were detected, the file fill be empty.</li><li>Delete the Docker container.</li></ul><h2 id="custom-shadow-database" tabindex="-1">Custom Shadow Database <a class="header-anchor" href="#custom-shadow-database" aria-label="Permalink to &quot;Custom Shadow Database&quot;">​</a></h2><p>By default, <strong>Sable</strong> uses a Docker container built from a version of the official <a href="https://hub.docker.com/_/postgres" target="_blank" rel="noreferrer">Postgres</a> image from the DockerHub registry. However, in a corporate environment, maybe you have to use an image from an internal private registry. Or maybe you just want to use a different image from DockerHub. That&#39;s possible. Any <strong>Sable</strong> command that needs to use a shadow database has a <code>-c|--container-options</code> option. That option can be used to point to a JSON file that contains the configuration for how build a custom container for the shadow database. An example looks like this:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;Image&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;postgres:15.1&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;PortBindings&quot;</span><span style="color:#E1E4E8;">: [</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;HostPort&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5470</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">&quot;ContainerPort&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#79B8FF;">5432</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  ],</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;EnvironmentVariables&quot;</span><span style="color:#E1E4E8;">: {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">&quot;PGPORT&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;5432&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">&quot;POSTGRES_DB&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">&quot;POSTGRES_USER&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">&quot;POSTGRES_PASSWORD&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  },</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">&quot;ConnectionString&quot;</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;Host=localhost;Port=5470;Username=postgres;Password=postgres;Database=postgres&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;Image&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;postgres:15.1&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;PortBindings&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;HostPort&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5470</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">&quot;ContainerPort&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">5432</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  ],</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;EnvironmentVariables&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;PGPORT&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;5432&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;POSTGRES_DB&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;POSTGRES_USER&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;POSTGRES_PASSWORD&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;postgres&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;ConnectionString&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;Host=localhost;Port=5470;Username=postgres;Password=postgres;Database=postgres&quot;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>ConnectionString</code> is the connection string that should be used to connect to the container once it is running.</p><h2 id="migration-tracking-and-idempotency" tabindex="-1">Migration Tracking and Idempotency <a class="header-anchor" href="#migration-tracking-and-idempotency" aria-label="Permalink to &quot;Migration Tracking and Idempotency&quot;">​</a></h2><p>To ensure applying a migration is executed as an idempotent operation, Sable maintains a table in the database called <code>&lt;database-schema-name&gt;.__sable_migrations</code> to keep track of already applied migrations. A migration script generated by <strong>Sable</strong> will look something like this:</p><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">---Generated by Sable on 10/14/2023 11:32:48 PM</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">DO $$</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">__sable_migrations</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> migration_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        RAISE NOTICE </span><span style="color:#9ECBFF;">&#39;Running migration with Id = 20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">mt_doc_order_idx_customer_id</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mt_doc_order</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USING</span><span style="color:#E1E4E8;"> btree ((</span><span style="color:#79B8FF;">CAST</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;CustomerId&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> uuid)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">__sable_migrations</span><span style="color:#E1E4E8;"> (migration_id, backfilled)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">BEGIN</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">DO $$</span></span>
<span class="line"><span style="color:#F97583;">BEGIN</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">SELECT</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">FROM</span><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">__sable_migrations</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">WHERE</span><span style="color:#E1E4E8;"> migration_id </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        RAISE NOTICE </span><span style="color:#9ECBFF;">&#39;Running migration with Id = 20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">INDEX</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">mt_doc_order_idx_date_purchased_utc</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">ON</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mt_doc_order</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">USING</span><span style="color:#E1E4E8;"> btree ((</span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">mt_immutable_timestamp</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">data</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-&gt;&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;DatePurchasedUtc&#39;</span><span style="color:#E1E4E8;">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">orders</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">__sable_migrations</span><span style="color:#E1E4E8;"> (migration_id, backfilled)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">IF</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#F97583;">END</span><span style="color:#E1E4E8;"> $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">COMMIT</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">---Generated by Sable on 10/14/2023 11:32:48 PM</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">DO $$</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__sable_migrations</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> migration_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        RAISE NOTICE </span><span style="color:#032F62;">&#39;Running migration with Id = 20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">mt_doc_order_idx_customer_id</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mt_doc_order</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USING</span><span style="color:#24292E;"> btree ((</span><span style="color:#005CC5;">CAST</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;CustomerId&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">as</span><span style="color:#24292E;"> uuid)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__sable_migrations</span><span style="color:#24292E;"> (migration_id, backfilled)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;20231013224735_AddIndexOnCustomerId&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">DO $$</span></span>
<span class="line"><span style="color:#D73A49;">BEGIN</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">SELECT</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">FROM</span><span style="color:#24292E;">  </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__sable_migrations</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">WHERE</span><span style="color:#24292E;"> migration_id </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">THEN</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        RAISE NOTICE </span><span style="color:#032F62;">&#39;Running migration with Id = 20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">INDEX</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">mt_doc_order_idx_date_purchased_utc</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">ON</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mt_doc_order</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">USING</span><span style="color:#24292E;"> btree ((</span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">mt_immutable_timestamp</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">data</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-&gt;&gt;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;DatePurchasedUtc&#39;</span><span style="color:#24292E;">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">orders</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">__sable_migrations</span><span style="color:#24292E;"> (migration_id, backfilled)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;20231014233240_AddIndexOnDatePurchased&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">END</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">IF</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#D73A49;">END</span><span style="color:#24292E;"> $$;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">COMMIT</span><span style="color:#24292E;">;</span></span></code></pre></div><p>If a record already exists in the table for a migration, It won&#39;t be applied. Otherwise, applying the migration as well as recording that it has been applied in the migration table will execute in the same database transaction.</p>`,13),e=[p];function t(r,c,E,y,i,d){return n(),a("div",null,e)}const h=s(l,[["render",t]]);export{F as __pageData,h as default};
